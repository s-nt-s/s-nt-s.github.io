<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Reconectar ethernet automaticamente</title>
<link href="/theme/css/main.css" rel="stylesheet"/>
<link href="/feeds/all.atom.xml" rel="alternate" title="Apuntes Atom Feed" type="application/atom+xml"/>
</head>
<body class="home" id="index">
<header class="body" id="banner">
<h1 class="entry-title"><a href="/reconectar-ethernet-automaticamente" rel="bookmark" title="Permalink to Reconectar ethernet automaticamente">Reconectar ethernet automaticamente</a></h1><div class="post-info">
<p>
<time class="published" datetime="2014-03-23T20:35:00+01:00" title="Publicado el 2014-03-23">2014-03-23</time>
<a class="bubble category ct_sistemas" href="/category/sistemas.html" title="Hay 17 entradas más sobre Sistemas">
Sistemas</a>
<a class="bubble tag tg_linux" href="/tag/linux.html" title="Hay 18 entradas  más sobre linux">
linux</a> <a class="bubble tag tg_redes" href="/tag/redes.html" title="Hay 9 entradas  más sobre redes">
redes</a> </p>
<p>
<span class="bubble">60 lineas</span> <span class="bubble wc">332 palabras</span> <span class="bubble wc">2.133 letras</span>
</p>
</div><!-- /.post-info --> </header><!-- /#banner -->
<section class="body" id="content">
<article>
<div class="entry-content">
<p><strong>Problema</strong>: Un equipo conectado vía ethernet se desconecta sin motivo
aparente. Este equipo se usa siempre remotamente, por lo tanto acceder
físicamente a él para reiniciarlo no es una buena solución.</p>
<p><strong>Solución</strong>: Automatizar el proceso de monitorizar el estado de la
conexión del ethernet y levantarlo en caso de caída.</p>
<p><strong>1-</strong> Crear script para ver el estado del ethernet y levantarlo si es
necesario.</p>
<div class="highlight"><pre><span></span><code><span class="gp">pi@bot ~ $ </span>sudo touch /usr/local/bin/eth
<span class="gp">pi@bot ~ $ </span>sudo chmod <span class="m">777</span> /usr/local/bin/eth
<span class="gp">pi@bot ~ $ </span>sudo nano /usr/local/bin/eth
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
ok<span class="o">()</span> <span class="o">{</span>
    <span class="nv">STATE</span><span class="o">=</span><span class="k">$(</span>ifconfig eth0 <span class="p">|</span> grep <span class="s2">"inet addr:"</span> <span class="p">|</span> sed <span class="s1">'s/^ *inet addr/Lan/'</span> <span class="p">|</span> sed <span class="s1">'s/  / /g'</span><span class="k">)</span>
    <span class="nv">IP</span><span class="o">=</span><span class="k">$(</span>curl -s icanhazip.com<span class="k">)</span>
    <span class="k">if</span> <span class="o">[</span> ! -z <span class="s2">"</span><span class="nv">$IP</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> -n <span class="s2">"Ip:</span><span class="nv">$IP</span><span class="s2"> "</span>
    <span class="k">else</span>
        <span class="nb">echo</span> -n <span class="s2">"IP ERROR - "</span>
    <span class="k">fi</span>
    <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$STATE</span><span class="s2">"</span>
<span class="o">}</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"--log"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> -n <span class="k">$(</span>date <span class="s2">"+%d/%m/%Y %H:%M &gt; "</span><span class="k">)</span><span class="s2">""</span>
<span class="k">fi</span>

<span class="k">if</span> ifconfig eth0 <span class="p">|</span> grep -q <span class="s2">"inet addr:"</span><span class="p">;</span> <span class="k">then</span>
    ok
    <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>

<span class="nv">ERR</span><span class="o">=</span><span class="k">$(</span>ifup --force eth0 <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="k">)</span>
<span class="nv">OUT</span><span class="o">=</span><span class="nv">$?</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$OUT</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> -n <span class="s2">"RESET OK - "</span>
    ok
<span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">"RESET FAIL - </span><span class="nv">$ERR</span><span class="s2">"</span>
<span class="k">fi</span>
</code></pre></div>
<p><strong>2-</strong> Ejemplo de uso desde linea de comandos</p>
<div class="highlight"><pre><span></span><code><span class="gp">pi@bot ~ $ </span>eth
<span class="go">Ip:81.65.17.125 Lan:192.168.1.69 Bcast:192.168.1.255 Mask:255.255.255.0</span>
<span class="gp">pi@bot ~ $ </span>eth --log
<span class="go">23/03/2014 21:14 &gt; Ip:81.65.17.125 Lan:192.168.1.69 Bcast:192.168.1.255 Mask:255.255.255.0</span>
<span class="gp">pi@bot ~ $ </span>sudo ifdown eth0
<span class="go">...</span>
<span class="gp">pi@bot ~ $ </span>eth
<span class="go">RESET FAIL - ifup: failed to open statefile /run/network/ifstate: Permission denied</span>
<span class="gp">pi@bot ~ $ </span>sudo eth
<span class="go">RESET OK - Ip:81.65.17.125 Lan:192.168.1.69 Bcast:192.168.1.255 Mask:255.255.255.0</span>
</code></pre></div>
<p><strong>3-</strong> Programar tarea cada 5 minutos</p>
<p>Editar el crontab de usuario root y añadir las siguientes lineas al
final del fichero</p>
<div class="highlight"><pre><span></span><code><span class="gp">pi@bot ~ $ </span>sudo nano /etc/crontab
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Cada 5 minutos testeamos el ethernet</span>
<span class="o">*/</span><span class="mi">5</span> <span class="o">*</span>   <span class="o">*</span> <span class="o">*</span> <span class="o">*</span>   <span class="n">root</span>    <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">eth</span> <span class="o">--</span><span class="nb">log</span>  <span class="o">|</span> <span class="n">grep</span> <span class="s2">"RESET\|ERROR"</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">eth</span><span class="o">.</span><span class="n">log</span>
</code></pre></div>
<p><strong>4-</strong> Ejemplos de log generado por crontab</p>
<div class="highlight"><pre><span></span><code><span class="err">20/03/2014 07:05 &gt; RESET OK - Ip:81.65.17.125 Lan:192.168.1.69 Bcast:192.168.1.255 Mask:255.255.255.0</span>
<span class="err">20/03/2014 16:05 &gt; RESET OK - Ip:81.65.17.125 Lan:192.168.1.69 Bcast:192.168.1.255 Mask:255.255.255.0</span>
<span class="err">21/03/2014 17:05 &gt; RESET OK - Ip:81.65.17.125 Lan:192.168.1.69 Bcast:192.168.1.255 Mask:255.255.255.0</span>
</code></pre></div>
<p>Fuente:
<a href="http://www.samhobbs.co.uk/2013/11/fix-for-ethernet-connection-drop-on-raspberry-pi/" target="_blank">samhobbs</a>
(<a href="http://webcache.googleusercontent.com/search?q=cache:T9cgkUiSUZsJ:www.samhobbs.co.uk/2013/11/fix-for-ethernet-connection-drop-on-raspberry-pi/+&amp;cd=1&amp;hl=es&amp;ct=clnk" target="_blank">cache</a>)</p>
</div><!-- /.entry-content -->
</article>
</section>
<footer class="body" id="extras">
<div class="menu">
<h2>Menú</h2>
<nav>
<ul>
<li>
<strong><a href="/">INICIO</a></strong>
</li>
<li><a href="/p/about">About</a></li>
<li><a href="/mapa">Mapa</a></li>
<li><a href="https://github.com/s-nt-s/s-nt-s.github.io/tree/main" target="_blank">Ver Github</a></li>
<li><a href="https://github.com/s-nt-s/s-nt-s.github.io/tree/main/themes/notmyidea-custom/templates/article.html" target="_blank">Ver Template</a></li>
<li><a href="https://github.com/s-nt-s/s-nt-s.github.io/tree/main/content/posts/2014-03-23_reconectar-ethernet-automaticamente.md" target="_blank">Ver Markdown</a></li>
</ul>
<ul>
<li><a href="https://validator.w3.org/check?charset=(detect+automatically)&amp;doctype=Inline&amp;group=1&amp;uri=https://s-nt-s.github.io/reconectar-ethernet-automaticamente" target="_blank">Validar HTML</a></li>
</ul>
</nav>
</div><!-- /.menu -->
<div class="social">
<h2>Social</h2>
<ul>
<li><a href="/feeds/all.atom.xml" rel="alternate" type="application/atom+xml">atom feed</a></li>
<li><a href="https://github.com/s-nt-s/" target="_blank">@s-nt-s</a></li>
<li><a href="xmpp:git@suchat.org">git@suchat.org</a></li>
</ul>
</div><!-- /.social -->
<div class="license">
<p><a class="logo" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.es" rel="license" target="_blank"><img alt="Licencia Creative Commons" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png"/></a> Esta obra está bajo una <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.es" rel="license" target="_blank">Licencia Creative Commons Atribución-NoComercial-CompartirIgual 4.0 Internacional</a>.</p>
</div>
</footer><!-- /#extras -->
</body>
</html>